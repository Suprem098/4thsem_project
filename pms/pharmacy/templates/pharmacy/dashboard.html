{% extends 'pharmacy/base.html' %}

{% block content %}

<!-- Dashboard Header & System Status -->
<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold text-dark mb-0">Dashboard</h2>
        <p class="text-muted mb-0">Welcome back, Admin.</p>
    </div>
    <div class="d-flex gap-2">
        <span class="badge bg-light-dark border d-flex align-items-center gap-2 px-3 py-2 rounded-pill">
            <i class="far fa-clock"></i> {% now "D, M d, Y" %}
        </span>
        <span class="badge bg-light-success border border-success d-flex align-items-center gap-2 px-3 py-2 rounded-pill">
            <i class="fas fa-check-circle"></i> System Operational
        </span>
    </div>
</div>

<!-- Quick Actions Toolbar -->
<div class="card mb-4 border-0 shadow-sm">
    <div class="card-body p-3 d-flex justify-content-between align-items-center">
        <h5 class="mb-0 fw-bold text-muted"><i class="fas fa-bolt me-2"></i>Quick Actions</h5>
        <div class="d-flex gap-2">
            <a href="{% url 'medicine_create' %}" class="btn btn-primary"><i class="fas fa-plus"></i> Add Medicine</a>
            <a href="{% url 'staff_create' %}" class="btn btn-warning"><i class="fas fa-user-shield"></i> Add Staff</a>
            <a href="{% url 'sales_report' %}" class="btn btn-info text-white"><i class="fas fa-chart-bar"></i> Reports</a>
        </div>
    </div>
</div>

<!-- Risk & Alerts Panel -->
{% if expiring_medicines or low_stock_medicines %}
<div class="mb-4">
    <h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.75rem; letter-spacing: 0.05em;">Attention Needed</h6>
    <div class="alert-strip-container">
        {% if expiring_medicines %}
        {% for med in expiring_medicines|slice:":3" %}
        <div class="alert-strip warning" onclick="window.location.href='{% url 'medicine_list' %}'">
            <div class="alert-content">
                <i class="fas fa-exclamation-triangle text-warning"></i>
                <span>Expiring: <strong>{{ med.name }}</strong></span>
            </div>
            <span class="alert-meta">{{ med.expiry_date }}</span>
        </div>
        {% endfor %}
        {% endif %}

        {% if low_stock_medicines %}
        {% for med in low_stock_medicines|slice:":3" %}
        <div class="alert-strip danger" onclick="window.location.href='{% url 'medicine_list' %}'">
            <div class="alert-content">
                <i class="fas fa-exclamation-circle text-danger"></i>
                <span>Low Stock: <strong>{{ med.name }}</strong></span>
            </div>
            <span class="alert-meta">{{ med.quantity }} left</span>
        </div>
        {% endfor %}
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Operations Overview (Compact Tiles) -->
<h6 class="text-uppercase text-muted fw-bold mb-3" style="font-size: 0.75rem; letter-spacing: 0.05em;">Operations Overview</h6>
<div class="summary-grid">
    <div class="summary-tile" onclick="window.location.href='{% url 'medicine_list' %}'">
        <div class="summary-icon primary"><i class="fas fa-pills"></i></div>
        <div class="summary-data">
            <span class="summary-label">Medicines</span>
            <span class="summary-value">{{ medicine_count }}</span>
        </div>
    </div>
    <div class="summary-tile" onclick="window.location.href='{% url 'order_list' %}'">
        <div class="summary-icon success"><i class="fas fa-shopping-cart"></i></div>
        <div class="summary-data">
            <span class="summary-label">Orders</span>
            <span class="summary-value">{{ order_count }}</span>
        </div>
    </div>
    <div class="summary-tile" onclick="window.location.href='{% url 'customer_list' %}'">
        <div class="summary-icon info"><i class="fas fa-users"></i></div>
        <div class="summary-data">
            <span class="summary-label">Customers</span>
            <span class="summary-value">{{ customer_count }}</span>
        </div>
    </div>
    <div class="summary-tile" onclick="window.location.href='{% url 'supplier_list' %}'">
        <div class="summary-icon warning"><i class="fas fa-truck"></i></div>
        <div class="summary-data">
            <span class="summary-label">Suppliers</span>
            <span class="summary-value">{{ supplier_count }}</span>
        </div>
    </div>
</div>

<!-- Pending Actions (Compact) -->
<div class="pending-grid">
    <div class="pending-tile" onclick="window.location.href='{% url 'order_list' %}'" style="cursor: pointer;">
        <div>
            <h6>Pending Orders</h6>
            <h3>{{ pending_orders_count }}</h3>
        </div>
        <div class="pending-icon-small text-info"><i class="fas fa-clock"></i></div>
    </div>
    <div class="pending-tile" onclick="window.location.href='{% url 'supplier_request_list' %}'" style="cursor: pointer;">
        <div>
            <h6>Supplier Requests</h6>
            <h3>{{ pending_requests_count }}</h3>
        </div>
        <div class="pending-icon-small text-warning"><i class="fas fa-truck-loading"></i></div>
    </div>
    <div class="pending-tile" onclick="window.location.href='{% url 'prescription_list' %}'" style="cursor: pointer;">
        <div>
            <h6>Prescriptions</h6>
            <h3>{{ pending_prescriptions_count }}</h3>
            <small class="text-muted" style="font-size: 0.7rem;">Pending Review</small>
        </div>
        <div class="pending-icon-small text-primary"><i class="fas fa-file-prescription"></i></div>
    </div>
    <div class="pending-tile" onclick="window.location.href='{% url 'appointment_list' %}'" style="cursor: pointer;">
        <div>
            <h6>Appointments</h6>
            <h3>{{ pending_appointments_count }}</h3>
            <small class="text-muted" style="font-size: 0.7rem;">Pending Approval</small>
        </div>
        <div class="pending-icon-small text-success"><i class="fas fa-calendar-check"></i></div>
    </div>
</div>

<!-- Analytics & Activity -->
<div class="row g-4">
    <!-- Today's Analytics -->
    <div class="col-lg-5">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white border-bottom-0 pt-4 px-4">
                <h5 class="fw-bold mb-0"><i class="fas fa-chart-pie me-2 text-primary"></i>Today's Performance</h5>
            </div>
            <div class="card-body px-4 pb-4">
                <div class="row g-3 mb-4">
                    <div class="col-6">
                        <div class="p-3 border rounded-3 text-center bg-light h-100">
                            <h6 class="text-muted small text-uppercase fw-bold mb-1">Revenue</h6>
                            <h3 class="text-success fw-bold mb-0">Rs. {{ todays_revenue|floatformat:0 }}</h3>
                        </div>
                    </div>
                    <div class="col-6">
                        <div class="p-3 border rounded-3 text-center bg-light h-100">
                            <h6 class="text-muted small text-uppercase fw-bold mb-1">Orders</h6>
                            <h3 class="text-primary fw-bold mb-0">{{ todays_orders_count }}</h3>
                        </div>
                    </div>
                </div>
                <h6 class="text-muted small text-uppercase fw-bold mb-3">Last 7 Days Trend</h6>
                <div style="position: relative; height: 180px; width: 100%;">
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="mt-4">
                    <a href="{% url 'sales_report' %}" class="btn btn-outline-primary w-100">View Detailed Report</a>
                </div>
            </div>
        </div>
    </div>

    <!-- Recent Activity -->
    <div class="col-lg-7">
        <div class="card h-100 border-0 shadow-sm">
            <div class="card-header bg-white border-bottom-0 pt-4 px-4 d-flex justify-content-between align-items-center">
                <h5 class="fw-bold mb-0"><i class="fas fa-history me-2 text-secondary"></i>Recent Activity</h5>
                <a href="{% url 'order_list' %}" class="text-decoration-none small fw-bold">View All</a>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="bg-light">
                            <tr>
                                <th class="ps-4 border-0">Time</th>
                                <th class="border-0">Order ID</th>
                                <th class="border-0">Customer</th>
                                <th class="pe-4 border-0 text-end">Status</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for order in recent_orders %}
                            <tr>
                                <td class="ps-4 text-muted small">{{ order.order_date|date:"H:i" }}</td>
                                <td class="fw-bold">#{{ order.id }}</td>
                                <td>{{ order.customer.name }}</td>
                                <td class="pe-4 text-end">
                                    {% if order.status == 'Pending' %}
                                    <span class="badge bg-warning text-dark rounded-pill px-3">Pending</span>
                                    {% elif order.status == 'Completed' %}
                                    <span class="badge bg-success rounded-pill px-3">Completed</span>
                                    {% else %}
                                    <span class="badge bg-danger rounded-pill px-3">Cancelled</span>
                                    {% endif %}
                                </td>
                            </tr>
                            {% empty %}
                            <tr>
                                <td colspan="4" class="text-center py-4 text-muted">No recent activity.</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const ctx = document.getElementById('revenueChart').getContext('2d');
        new Chart(ctx, {
            type: 'line',
            data: {
                labels: {{ chart_labels|safe }},
                datasets: [{
                    label: 'Revenue',
                    data: {{ chart_data|safe }},
                    borderColor: '#6366f1',
                    backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 2,
                    fill: true,
                    tension: 0.4,
                    pointRadius: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        grid: { borderDash: [2, 4], color: '#e2e8f0' },
                        ticks: { font: { size: 10 } }
                    },
                    x: {
                        grid: { display: false },
                        ticks: { font: { size: 10 } }
                    }
                }
            }
        });
    });
</script>
{% endblock %}